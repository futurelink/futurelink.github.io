---
title: Использование OpenOCD с STM32
layout: post
---
Для того, чтобы прошить контроллер с помощью OpenOCD нужно иметь ввиду следующее:

### Конфигурационный файл

Надо сделать вот такой файл, который в последующем скормить OpenOCD. Можно назвать его, к примеру **stm32f0_discovery.cfg**.

```
source [find interface/stlink-v2.cfg]

set WORKAREASIZE 0x2000
source [find target/stm32f0x_stlink.cfg]

# use hardware reset, connect under reset
reset_config srst_only srst_nogate

```

Этот файл будет говорить OpenOCD что надо заюзать программатор STLink v2, а в качестве платформы
будет использоваться девайс STM32F0.

Тут есть ньюанс - последнюю строку надо _закомметировать_, если юзается не отладочная плата discovery,
а какая-то иная (например китайская) плата или голый контроллер.

### Скрипт для OpenOCD

Потом надо сделать вот такой файлик, который будет описывать, что OpenOCD должно делать с нашим контроллером
на определенных этапах работы. Назовем его, к примеру **stm32-openocd.cfg**.

```
init

proc stm_flash {IMGFILE} {
	reset halt
	sleep 100
	wait_halt 2
	flash write_image erase $IMGFILE 0x08000000
	sleep 100 
	verify_image $IMGFILE 0x08000000
	sleep 100
	reset run
}

proc stm_erase {} {
	reset halt
	sleep 100
	stm32f0x mass_erase 0
	sleep 100
}

```

Тут мы полюбасу делаем init, а потом, в зависимости от того, что мы хотим от прошивальшика (какой proc мы выполняем)
производится определенная последовательность действий. Собственно, чтобы прошить (stm_flash) мы делаем ресет, потом ждем 100мс,
делает запись образа пршивки, ждем, проверяем, что все корректно зафлешилось и снова ждем и расхальчиваем наш контроллер.

Ну а чтобы стереть всю прошивку - ресетим, ждем, ерейзим все и снова ждем. Запускать уже нечего, поэтому завершаем так.

### Some automation

Можно написать как-нибудь makefile, который будет все это делать после сборки прошивки. Для этого надо в него вписать следующее:

```
openocd -f stm32f0_discovery.cfg -f stm32-openocd.cfg -c "stm_flash `pwd`/myflashimage.bin" -c shutdown
```

В общем-то, как видно, два конфга, которые мы сделали перед этим можно слить в один и не париться. Однако, если планируется
прошивать разные контроллеры с разными программаторами, то лушче опции прошивки держать отдельно, а процедуры отдельно. Короче
мухи от котлет надо отделять.

That's all kids.

